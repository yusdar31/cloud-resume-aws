name: Deploy Cloud Resume to AWS

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  AWS_REGION: us-east-1
  TERRAFORM_VERSION: 1.5.0

jobs:
  # Job 1: Validate and Test
  validate:
    name: Validate & Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install Python Dependencies
      run: |
        pip install boto3 pytest

    - name: Validate Lambda Function Syntax
      run: |
        python -m py_compile lambda/func.py
        echo "âœ… Lambda function syntax is valid"

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}

    - name: Terraform Format Check
      run: terraform fmt -check -recursive
      continue-on-error: true

    - name: Terraform Validate
      run: |
        terraform init -backend=false
        terraform validate

  # Job 2: Plan (Preview Changes)
  plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}
        terraform_wrapper: false

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Terraform Init
      run: terraform init

    - name: Terraform Plan
      run: terraform plan -no-color
      continue-on-error: true

  # Job 3: Deploy to AWS
  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}
        terraform_wrapper: false

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Terraform Init
      run: terraform init

    - name: Terraform Plan
      run: terraform plan -out=tfplan

    - name: Terraform Apply
      run: terraform apply -auto-approve tfplan

    - name: Get CloudFront Distribution ID
      id: cloudfront
      run: |
        DIST_ID=$(terraform output -raw cloudfront_distribution_id)
        echo "distribution_id=$DIST_ID" >> $GITHUB_OUTPUT
        echo "âœ… CloudFront Distribution ID: $DIST_ID"

    - name: Invalidate CloudFront Cache
      run: |
        aws cloudfront create-invalidation \
          --distribution-id ${{ steps.cloudfront.outputs.distribution_id }} \
          --paths "/*"
        echo "âœ… CloudFront cache invalidation initiated"

    - name: Get Website URL
      run: |
        WEBSITE_URL=$(terraform output -raw website_url)
        API_URL=$(terraform output -raw api_gateway_url)
        echo "ğŸŒ Website: https://$WEBSITE_URL"
        echo "ğŸš€ API Gateway: $API_URL"

  # Job 4: Test Deployment
  test:
    name: Test Deployment
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION }}
        terraform_wrapper: false

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Terraform Init
      run: terraform init

    - name: Test API Gateway Endpoint
      run: |
        API_URL=$(terraform output -raw api_gateway_url)
        echo "Testing API Gateway: $API_URL"
        
        RESPONSE=$(curl -s -w "\n%{http_code}" $API_URL)
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        BODY=$(echo "$RESPONSE" | head -n-1)
        
        echo "HTTP Status: $HTTP_CODE"
        echo "Response Body: $BODY"
        
        if [ "$HTTP_CODE" != "200" ]; then
          echo "âŒ API Gateway test failed! HTTP $HTTP_CODE"
          exit 1
        fi
        
        if ! echo "$BODY" | grep -q "count"; then
          echo "âŒ Response doesn't contain 'count' field"
          exit 1
        fi
        
        echo "âœ… API Gateway is working correctly!"

    - name: Test Website Availability
      run: |
        WEBSITE_URL=$(terraform output -raw website_url)
        echo "Testing website: https://$WEBSITE_URL"
        
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://$WEBSITE_URL)
        
        if [ "$HTTP_CODE" != "200" ]; then
          echo "âŒ Website test failed! HTTP $HTTP_CODE"
          exit 1
        fi
        
        echo "âœ… Website is accessible!"

    - name: Deployment Summary
      run: |
        echo "ğŸ‰ Deployment Successful!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“Š Deployment Summary:"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        WEBSITE_URL=$(terraform output -raw website_url)
        API_URL=$(terraform output -raw api_gateway_url)
        echo "ğŸŒ Website URL: https://$WEBSITE_URL"
        echo "ğŸš€ API Gateway: $API_URL"
        echo "âœ… All tests passed!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"